@page "/"
@using EFCore.BulkExtensions

@inject IGuestCardService GuestCardService
@inject AppDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IImportService ImportService
@inject IExportService ExportService
@inject ILogger<Home> Logger
@inject IDialogService DialogService
@inject IDatabaseService DatabaseService

<MudStack>
    <MudStack Row>
        <HUIButton OnClick="ScanCard" Style="width: 100%" Size="Size.Small"
               Color="Color.Primary" Variant="Variant.Filled" Loading="@_isScanning"
               Ripple="false" DropShadow="false">
            Quét Phòng
        </HUIButton>
        <HUIButton OnClick="OpenFindManually" Style="width: 100%" Size="Size.Small"
                   Color="Color.Primary" Variant="Variant.Filled" 
                   Ripple="false" DropShadow="false">
            Nhập Phòng Thủ Công
        </HUIButton>
    </MudStack>

    <MudFileUpload T="IBrowserFile" FilesChanged="ImportMaxTowel" Style="width: 100%">
        <ActivatorContent>
            <HUIButton Variant="Variant.Filled" Loading="@_isImporting"
            Size="Size.Small" Style="width: 100%"
                       Color="Color.Primary" Ripple="false" DropShadow="false"
                       StartIcon="@Icons.Material.Filled.ImportExport">
                Cập Nhật Số Lượng Khách Trong Ngày 
            </HUIButton>
        </ActivatorContent>
    </MudFileUpload>

    <HUIButton Color="Color.Primary" Variant="Variant.Filled" FullWidth Size="Size.Small"
    Loading="@_isExporting"
               StartIcon="@Icons.Material.Filled.ImportExport"
               OnClick="ExportExcel" 
               Ripple="false" DropShadow="false">
        Xuất Excel Cuối Ngày
    </HUIButton>

    <HUIButton Color="Color.Primary" Variant="Variant.Filled" FullWidth Size="Size.Small"
               StartIcon="@Icons.Material.Filled.Settings"
               OnClick="@(() => NavigationManager.NavigateTo("/settings"))"
               Ripple="false" DropShadow="false">
        Cấu Hình
    </HUIButton>

    <MudStack Row>
        <HUIButton Color="Color.Primary" Variant="Variant.Filled" FullWidth Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.Settings"
                   OnClick="DeleteOldData" Style="width: 100%"
                   Ripple="false" DropShadow="false">
            Xóa Dữ Liệu Cũ (Quá 30 Ngày)
        </HUIButton>
    </MudStack>
    <MudText Typo="Typo.subtitle2">Dung lượng database còn lại: @_storageInfo?.RemainingSize</MudText>
</MudStack>

@code {
    private bool _isScanning = false;
    private bool _isImporting = false;
    private bool _isExporting = false;
    IList<IBrowserFile> _files = new List<IBrowserFile>();
    private DatabaseStorageInfo? _storageInfo;

    protected override async Task OnInitializedAsync()
    {
        _storageInfo = await DatabaseService.GetDatabaseStorageInfoAsync();
        await base.OnInitializedAsync();
    }

    private async Task ScanCard()
    {
        _isScanning = true;

        var cardOcrResult = await GuestCardService.ExtractGuestCardAsync(1);
        if (cardOcrResult.CardInfo != null && string.IsNullOrEmpty(cardOcrResult.ErrorMessage))
        {
            var existingCard = await DbContext.GuestCards
                .FirstOrDefaultAsync(c => c.RoomNo == cardOcrResult.CardInfo.RoomNo
                    && c.Building == NormalizeBuilding(cardOcrResult.CardInfo.Building));

            if (existingCard == null)
            {
                _isScanning = false;
                Snackbar.Add($"OCR ra phòng không hợp lệ. Vui lòng thử lại!", Severity.Error, (cfg) =>
                {
                    cfg.RequireInteraction = false;
                    cfg.VisibleStateDuration = 800;
                });
                return;
            }

            NavigationManager.NavigateTo($"/operation/{existingCard.CardNumber}");
        }
        else
        {
            Snackbar.Add($"OCR thất bại: {cardOcrResult.ErrorMessage}. Vui lòng thử lại!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }

        _isScanning = false;
    }

    private string NormalizeBuilding(string raw)
    {
        if (raw == "01") return "1";
        if (raw == "02") return "2";

        return raw;
    }

    private async Task ImportMaxTowel(IBrowserFile file)
    {
        _isImporting = true;

        try
        {
            using var stream = file.OpenReadStream();
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            byte[] fileBytes = ms.ToArray();
            var rows = ImportService.ReadExcel(fileBytes);

            var toUpdate = new List<MaxClientMonitor>();
            var toAdd = new List<MaxClientMonitor>();

            // Load tất cả MaxClientMonitor vào memory một lần
            var existingMonitors = await DbContext.MaxClientMonitors
                .ToDictionaryAsync(x => (x.Building, x.RoomNo), x => x);

            foreach (var row in rows)
            {
                var roomNoBuildingStr = row[0];
                var maxStr = row[1];

                var buildingStr = roomNoBuildingStr.Substring(0, 1);
                var roomNoStr = roomNoBuildingStr.Substring(1);

                if (buildingStr == "A")
                    buildingStr = "1";
                else if (buildingStr == "B")
                    buildingStr = "2";
                else if (roomNoBuildingStr.Length == 4)
                {
                    buildingStr = "Villa";
                    roomNoStr = roomNoBuildingStr;
                }
                else
                {
                    continue;
                }

                if (!int.TryParse(roomNoStr, out int roomNo) ||
                !int.TryParse(maxStr, out int max))
                {
                    continue;
                }

                var key = (buildingStr, roomNoStr);
                if (existingMonitors.TryGetValue(key, out var existingMaxClientMonitor))
                {
                    existingMaxClientMonitor.MaxQuantity = max;
                    toUpdate.Add(existingMaxClientMonitor);
                }
                else
                {
                    var maxClientMonitor = new MaxClientMonitor(buildingStr, roomNoStr, max);
                    toAdd.Add(maxClientMonitor);
                }
            }

            if (toUpdate.Any())
                await DbContext.BulkUpdateAsync(toUpdate);
            
            if (toAdd.Any())
                await DbContext.BulkInsertAsync(toAdd);

            Snackbar.Add("Thao tác thành công!", Severity.Success, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        catch (Exception)
        {
            Snackbar.Add("Có lỗi xảy ra!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        finally
        {
            _isImporting = false;
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            _isExporting = true;
            StateHasChanged();

            var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
            var today = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, vietnamTimeZone).Date;
            var borrowRecords = await DbContext.BorrowRecords
                    .Include(x => x.GuestCard)
                    .Where(x => x.CreatedAt >= today && x.CreatedAt < today.AddDays(1))
                    .ToListAsync();

            if (!borrowRecords.Any())   
            {
                Snackbar.Add("Không có khách nào chưa trả khăn!", Severity.Info, (cfg) =>
                {
                    cfg.RequireInteraction = false;
                    cfg.VisibleStateDuration = 800;
                });
                return;
            }

            await ExportService.ExportBorrowInfo(borrowRecords);
            Snackbar.Add("Export thành công!", Severity.Success, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        catch (Exception e)
        {
            Logger.LogError("Error while exporting borrow information: {errMessage}", e.Message);
            Snackbar.Add("Có lỗi xảy ra! Thử lại sau!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task OpenFindManually()
    {
        var parameters = new DialogParameters<VillaInputDialog>();
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall
        };
        var dialog = await DialogService.ShowAsync<VillaInputDialog>("Villa", parameters, options);
        var dialogResult = await dialog.Result;

        if (dialogResult != null && !dialogResult.Canceled)
        {
            var data = (ReturnDataForManualInput)dialogResult.Data!;
            var roomNo = data.RoomNo;
            var building = data.Building;
            var guestCard = await DbContext.GuestCards
                        .Where(x => x.Building == building && x.RoomNo == roomNo)
                        .FirstOrDefaultAsync();

            if (guestCard != null)
            {
                NavigationManager.NavigateTo($"/operation/{guestCard.CardNumber}");
            }
            else
            {
                Snackbar.Add("Villa không tồn tại!", Severity.Error, (cfg) =>
                {
                    cfg.RequireInteraction = false;
                    cfg.VisibleStateDuration = 800;
                });
            }
        }
    }

    private async Task DeleteOldData()
    {
        try
        {
            var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
            var cutoffDate = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, vietnamTimeZone).Date.AddDays(-30);
            var oldRecords = await DbContext.BorrowRecords
                .Where(x => x.CreatedAt < cutoffDate)
                .ToListAsync();
            if (oldRecords.Any())
            {
                DbContext.BorrowRecords.RemoveRange(oldRecords);
                await DbContext.SaveChangesAsync();
            }
            Snackbar.Add("Xóa dữ liệu cũ thành công!", Severity.Success, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        catch (Exception e)
        {
            Logger.LogError("Error while deleting old data: {errMessage}", e.Message);
            Snackbar.Add("Có lỗi xảy ra! Thử lại sau!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
    }
}
