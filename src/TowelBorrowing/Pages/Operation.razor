@page "/operation/{CardNumber}"

@inject IGuestCardService GuestCardService
@inject AppDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILogger<Operation> Logger
@inject IBorrowNotificationService NotificationService

<MudStack Spacing="2"> 
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudText>
                TÒA: @GetBuilding(_card?.Building)
            </MudText>
            @if (_card?.Floor != null)
            {
                <MudText>
                    TẦNG: @_card.Floor
                </MudText>
            }
        </MudStack>
        <MudText Typo="Typo.h6">
            PHÒNG: @_card?.RoomNo
        </MudText>
    </MudStack>

    <MudStack Row>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Đã mượn: @_borrowedCount</MudText>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Đã trả: @_returnedCount</MudText>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Còn thiếu: @(_borrowedCount - _returnedCount)</MudText>
    </MudStack>

    <MudGrid Spacing="2">
        <MudItem xs="12">
            <MudAlert Severity="Severity.Warning" Style="width: 100%" NoIcon Dense>
                Số lượng người trong phòng: @_maxBorrow <br />
                @if (RemainCount > 0)
                {
                    <p>Còn đặt được @RemainCount</p>
                }
                else
                {
                    <p>Vượt số lượng người trong phòng</p>
                }
            </MudAlert>
        </MudItem>
        <MudItem xs="6">
            <MudTextField @bind-Value="@_borrowCount" Immediate 
                          Style="width: 100%" ShrinkLabel
                      Margin="Margin.Dense" Variant="Variant.Outlined" Label="Số lượng mượn" />

            
        </MudItem>
        <MudItem xs="6">
            <HUIButton Color="Color.Primary" Variant="Variant.Filled" Style="width: 100%"
                       Size="Size.Small"
                       OnClick="@(() => Submit("borrow"))"
                       Ripple="false" DropShadow="false">
                Mượn
            </HUIButton>
        </MudItem>

        <MudItem xs="6">
            <MudTextField @bind-Value="@_returnCount" 
                          Immediate Style="width: 100%" ShrinkLabel 
                      Margin="Margin.Dense" Variant="Variant.Outlined" Label="Số lượng trả" />
        </MudItem>
        <MudItem xs="6">
            <HUIButton Color="Color.Primary" Variant="Variant.Filled" Style="width: 100%"
                       Size="Size.Small"
                       OnClick="@(() => Submit("return"))"
                       Ripple="false" DropShadow="false">
                Trả
            </HUIButton>
        </MudItem>
        <MudItem xs="12">
            <HUIButton Color="Color.Secondary" Variant="Variant.Outlined" Style="width: 100%"
                       Size="Size.Small"
                       OnClick="@(() => NavigationManager.NavigateTo("/"))"
                       Ripple="false" DropShadow="false">
                Thoát
            </HUIButton>
        </MudItem>
    </MudGrid>
</MudStack>



    @code {

    [Parameter]
    public string CardNumber { get; set; } = string.Empty;

    private GuestCard? _card;
    private int _borrowCount = 0;
    private int _returnCount = 0;

    private int _maxBorrow;
    private int _borrowedCount;
    private int _returnedCount;
    private int RemainCount => _maxBorrow - _borrowedCount;

    private DateTime GetTodayDate()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        return localNow.Date;
    }

    private DateTime GetTodayStartUtc()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        var todayStart = localNow.Date; 
        return TimeZoneInfo.ConvertTimeToUtc(todayStart, vietnamTimeZone);
    }

    private DateTime GetTodayEndUtc()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        var tomorrowStart = localNow.Date.AddDays(1); 
        return TimeZoneInfo.ConvertTimeToUtc(tomorrowStart, vietnamTimeZone);
    }

    protected override async Task OnInitializedAsync()
    {
        _card = await DbContext.GuestCards
            .FirstOrDefaultAsync(x => x.CardNumber == CardNumber);

        if (_card == null) return;

        var maxClientMonitor = await DbContext.MaxClientMonitors
                .FirstOrDefaultAsync(x => x.RoomNo == _card.RoomNo
                    && x.Building == _card.Building);
        if (maxClientMonitor != null)
        {
            _maxBorrow = maxClientMonitor.MaxQuantity;
        }

        var todayStartUtc = GetTodayStartUtc();
        var todayEndUtc = GetTodayEndUtc();
        
        var borrowRecord = await DbContext.BorrowRecords
            .Include(x => x.GuestCard)
            .FirstOrDefaultAsync(x => x.GuestCardNumber == _card.CardNumber
                    && x.CreatedAt >= todayStartUtc
                    && x.CreatedAt < todayEndUtc);

        if (borrowRecord != null)
        {
            _borrowedCount = borrowRecord.BorrowQuantity;
            _returnedCount = borrowRecord.ReturnQuantity;
        }
    }

    private async Task Submit(string action)
    {
        if (_card == null) return;

        try
        {
            var todayStartUtc = GetTodayStartUtc();
            var todayEndUtc = GetTodayEndUtc();
            
            var borrowRecord = await DbContext.BorrowRecords
                        .Include(x => x.GuestCard)
                        .FirstOrDefaultAsync(x => x.GuestCardNumber == _card.CardNumber
                           && x.CreatedAt >= todayStartUtc
                           && x.CreatedAt < todayEndUtc);

            if (borrowRecord == null)
            {
                borrowRecord = new BorrowRecord(_card.CardNumber);
                DbContext.BorrowRecords.Add(borrowRecord);
                await DbContext.SaveChangesAsync();
            }

            if (action == "borrow")
            {
                var result = borrowRecord.Borrow(_borrowCount);
                if (result.IsFailed)
                {
                    Snackbar.Add(result.Errors[0].Message, Severity.Error, (cfg) =>
                    {
                        cfg.RequireInteraction = false;
                        cfg.VisibleStateDuration = 800;
                    });
                    return;
                }
                await DbContext.SaveChangesAsync();
                await NotificationService.NotifyBorrowAsync(_card.CardNumber, _card.RoomNo, _card.Building, _borrowCount);
            }

            if (action == "return")
            {
                var result = borrowRecord.Return(_returnCount);
                if (result.IsFailed)
                {
                    Snackbar.Add(result.Errors[0].Message, Severity.Error, (cfg) =>
                    {
                        cfg.RequireInteraction = false;
                        cfg.VisibleStateDuration = 800;
                    });
                    return;
                }
                await DbContext.SaveChangesAsync();
                await NotificationService.NotifyReturnAsync(_card.CardNumber, _card.RoomNo, _card.Building, _returnCount);
            }

            Snackbar.Add($"Thao tác thành công!", Severity.Success, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });

            _borrowedCount = borrowRecord.BorrowQuantity;
            _returnedCount = borrowRecord.ReturnQuantity;
            
            await NotificationService.NotifyBorrowRecordUpdatedAsync(_card.CardNumber, _borrowedCount, _returnedCount);
        }
        catch (Exception e)
        {
            Logger.LogError("Error while borrowing/returning: {errMessage}", e.Message);
            Snackbar.Add($"Có lỗi xảy ra! Thử lại sau!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
    }

    private string? GetBuilding(string? raw)
    {
        if (raw == "1") return "A";
        if (raw == "2") return "B";

        return raw;
    }
}
