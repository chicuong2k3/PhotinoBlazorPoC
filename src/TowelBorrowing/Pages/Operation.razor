@page "/operation/{CardNumber}"

@inject IGuestCardService GuestCardService
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILogger<Operation> Logger
@inject IBorrowNotificationService NotificationService
@inject ILogger<Operation> Logger

@implements IAsyncDisposable

<MudStack Spacing="2"> 
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudText>
                TÒA: @GetBuilding(_card?.Building)
            </MudText>
            @if (_card?.Floor != null)
            {
                <MudText>
                    TẦNG: @_card.Floor
                </MudText>
            }
        </MudStack>
        <MudText Typo="Typo.h6">
            PHÒNG: @_card?.RoomNo
        </MudText>
    </MudStack>

    <MudStack Row>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Đã mượn: @_borrowedCount</MudText>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Đã trả: @_returnedCount</MudText>
        <MudText Typo="Typo.subtitle2" Color="Color.Error">Còn thiếu: @(_borrowedCount - _returnedCount)</MudText>
    </MudStack>

    <MudGrid Spacing="2">
        <MudItem xs="12">
            <MudAlert Severity="Severity.Warning" Style="width: 100%" NoIcon Dense>
                Số lượng người trong phòng: @_maxBorrow <br />
                @if (RemainCount > 0)
                {
                    <p>Còn đặt được @RemainCount</p>
                }
                else
                {
                    <p>Vượt số lượng người trong phòng</p>
                }
            </MudAlert>
        </MudItem>
        <MudItem xs="6">
            <MudTextField @bind-Value="@_borrowCount" Immediate 
            Style="width: 100%" ShrinkLabel
            Margin="Margin.Dense" Variant="Variant.Outlined" Label="Số lượng mượn" />


        </MudItem>
        <MudItem xs="6">
            <HUIButton Color="Color.Primary" Variant="Variant.Filled" Style="width: 100%"
            Size="Size.Small"
            OnClick="@(() => Submit("borrow"))"
            Disabled="@_isSubmitting"
            Ripple="false" DropShadow="false">
                Mượn
            </HUIButton>
        </MudItem>

        <MudItem xs="6">
            <MudTextField @bind-Value="@_returnCount" 
            Immediate Style="width: 100%" ShrinkLabel 
            Margin="Margin.Dense" Variant="Variant.Outlined" Label="Số lượng trả" />
        </MudItem>
        <MudItem xs="6">
            <HUIButton Color="Color.Primary" Variant="Variant.Filled" Style="width: 100%"
            Size="Size.Small"
            OnClick="@(() => Submit("return"))"
            Disabled="@_isSubmitting"
            Ripple="false" DropShadow="false">
                Trả
            </HUIButton>
        </MudItem>
        <MudItem xs="12">
            <HUIButton Color="Color.Secondary" Variant="Variant.Outlined" Style="width: 100%"
            Size="Size.Small"
            OnClick="@(() => NavigationManager.NavigateTo("/"))"
            Ripple="false" DropShadow="false">
                Thoát
            </HUIButton>
        </MudItem>
    </MudGrid>
</MudStack>



@code {

    [Parameter]
    public string CardNumber { get; set; } = string.Empty;

    private GuestCard? _card;
    private int _borrowCount = 0;
    private int _returnCount = 0;

    private int _maxBorrow;
    private int _borrowedCount;
    private int _returnedCount;
    private int RemainCount => _maxBorrow - _borrowedCount;
    private bool _isSubmitting = false;

    private DateTime GetTodayDate()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        return localNow.Date;
    }

    private DateTime GetTodayStartUtc()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        var todayStart = localNow.Date; 
        return TimeZoneInfo.ConvertTimeToUtc(todayStart, vietnamTimeZone);
    }

    private DateTime GetTodayEndUtc()
    {
        var vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
        var localNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, vietnamTimeZone);
        var tomorrowStart = localNow.Date.AddDays(1); 
        return TimeZoneInfo.ConvertTimeToUtc(tomorrowStart, vietnamTimeZone);
    }

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbContextFactory.CreateDbContextAsync();

        _card = await dbContext.GuestCards
            .FirstOrDefaultAsync(x => x.CardNumber == CardNumber);

        if (_card == null) return;

        var maxClientMonitor = await dbContext.MaxClientMonitors
                .FirstOrDefaultAsync(x => x.RoomNo == _card.RoomNo
                    && x.Building == _card.Building);
        if (maxClientMonitor != null)
        {
            _maxBorrow = maxClientMonitor.MaxQuantity;
        }

        await LoadTodayRecordAsync();

        // Subscribe to real-time updates
        NotificationService.OnBorrowUpdated += HandleBorrowUpdated;
        NotificationService.OnReturnUpdated += HandleReturnUpdated;
        await NotificationService.StartAsync();
    }

    private async Task LoadTodayRecordAsync()
    {
        if (_card == null) return;

        await using var dbContext = await DbContextFactory.CreateDbContextAsync();

        var todayStartUtc = GetTodayStartUtc();
        var todayEndUtc = GetTodayEndUtc();

        var borrowRecord = await dbContext.BorrowRecords
            .Include(x => x.GuestCard)
            .AsNoTracking()
            .FirstOrDefaultAsync(x => x.GuestCardNumber == _card.CardNumber
                    && x.CreatedAt >= todayStartUtc
                    && x.CreatedAt < todayEndUtc);

        if (borrowRecord != null)
        {
            _borrowedCount = borrowRecord.BorrowQuantity;
            _returnedCount = borrowRecord.ReturnQuantity;
        }
        else
        {
            _borrowedCount = 0;
            _returnedCount = 0;
        }
    }

    private async Task HandleBorrowUpdated(BorrowNotification notification)
    {
        if (notification.CardNumber == CardNumber)
        {
            // Reload from database to get accurate counts
            await LoadTodayRecordAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleReturnUpdated(BorrowNotification notification)
    {
        if (notification.CardNumber == CardNumber)
        {
            // Reload from database to get accurate counts
            await LoadTodayRecordAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task Submit(string action)
    {
        if (_card == null || _isSubmitting) return;

        _isSubmitting = true;
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();

            var todayStartUtc = GetTodayStartUtc();
            var todayEndUtc = GetTodayEndUtc();

            // Use transaction for atomicity
            using var transaction = await dbContext.Database.BeginTransactionAsync();

            try
            {
                var borrowRecord = await dbContext.BorrowRecords
                            .Include(x => x.GuestCard)
                            .FirstOrDefaultAsync(x => x.GuestCardNumber == _card.CardNumber
                               && x.CreatedAt >= todayStartUtc
                               && x.CreatedAt < todayEndUtc);

                if (borrowRecord == null)
                {
                    borrowRecord = new BorrowRecord(_card.CardNumber);
                    dbContext.BorrowRecords.Add(borrowRecord);
                    await dbContext.SaveChangesAsync();
                }

                if (action == "borrow")
                {
                    var result = borrowRecord.Borrow(_borrowCount);
                    if (result.IsFailed)
                    {
                        Snackbar.Add(result.Errors[0].Message, Severity.Error, (cfg) =>
                        {
                            cfg.RequireInteraction = false;
                            cfg.VisibleStateDuration = 800;
                        });
                        return;
                    }
                    await dbContext.SaveChangesAsync();

                    Logger.LogWarning("Action: Mượn {BorrowCount} khăn. Phòng: {RoomNo}, Tòa: {Building}. Số lượng mượn hiện tại: {BorrowQuantity}. Số lượng trả hiện tại: {ReturnQuantity}",
                        _borrowCount, borrowRecord.GuestCard.RoomNo, borrowRecord.GuestCard.Building, borrowRecord.BorrowQuantity, borrowRecord.ReturnQuantity);


                    // Reload the entity to get updated values from database
                    await dbContext.Entry(borrowRecord).ReloadAsync();


                    

                    await transaction.CommitAsync();

                    // Notify others (not yourself)
                    await NotificationService.NotifyBorrowAsync(_card.CardNumber, _card.RoomNo, _card.Building, _borrowCount);
                    
                    // Update local state from the saved record
                    _borrowedCount = borrowRecord.BorrowQuantity;
                    _returnedCount = borrowRecord.ReturnQuantity;
                    _borrowCount = 0;
                }
                else if (action == "return")
                {
                    var result = borrowRecord.Return(_returnCount);
                    if (result.IsFailed)
                    {
                        Snackbar.Add(result.Errors[0].Message, Severity.Error, (cfg) =>
                        {
                            cfg.RequireInteraction = false;
                            cfg.VisibleStateDuration = 800;
                        });
                        return;
                    }
                    await dbContext.SaveChangesAsync();

                    Logger.LogWarning("Action: Trả {ReturnCount} khăn. Phòng: {RoomNo}, Tòa: {Building}. Số lượng mượn hiện tại: {BorrowQuantity}. Số lượng trả hiện tại: {ReturnQuantity}",
                         _returnCount, borrowRecord.GuestCard.RoomNo, borrowRecord.GuestCard.Building, borrowRecord.BorrowQuantity, borrowRecord.ReturnQuantity);

                    
                    // Reload the entity to get updated values from database
                    await dbContext.Entry(borrowRecord).ReloadAsync();


                    
                    
                    await transaction.CommitAsync();

                    
                    // Notify others (not yourself)
                    await NotificationService.NotifyReturnAsync(_card.CardNumber, _card.RoomNo, _card.Building, _returnCount);
                    
                    // Update local state from the saved record
                    _borrowedCount = borrowRecord.BorrowQuantity;
                    _returnedCount = borrowRecord.ReturnQuantity;
                    _returnCount = 0;
                }

                Snackbar.Add($"Thao tác thành công!", Severity.Success, (cfg) =>
                {
                    cfg.RequireInteraction = false;
                    cfg.VisibleStateDuration = 800;
                });
            }
            catch
            {
                await transaction.RollbackAsync();
                throw;
            }
        }
        catch (Exception e)
        {
            Logger.LogError("Error while borrowing/returning: {errMessage}", e.Message);
            Snackbar.Add($"Có lỗi xảy ra! Thử lại sau! {e.Message}", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? GetBuilding(string? raw)
    {
        if (raw == "1") return "A";
        if (raw == "2") return "B";

        return raw;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        NotificationService.OnBorrowUpdated -= HandleBorrowUpdated;
        NotificationService.OnReturnUpdated -= HandleReturnUpdated;
        await NotificationService.StopAsync();
    }
}
