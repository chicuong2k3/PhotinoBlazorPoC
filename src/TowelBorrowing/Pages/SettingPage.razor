@page "/settings"

@inject NavigationManager NavigationManager
@inject AppDbContext DbContext
@inject ISnackbar Snackbar

<MudStack Spacing="3">
    <MudGrid Spacing="2" Justify="Justify.SpaceBetween">
        @foreach (var pair in _keyValuePairs)
        {
            <MudItem sm="6">
                <MudTextField Value="@pair.Key" ReadOnly Typo="Typo.button"
                              Immediate Style="width: 100%" ShrinkLabel
                              Margin="Margin.Dense" Variant="Variant.Outlined" Label="Key" />
            </MudItem>
            <MudItem sm="6">
                <MudTextField Value="@pair.Value" Typo="Typo.button"
                              ValueChanged="@(async (string value) => await HandleValueChanged(pair.Key, value))"
                              Immediate Style="width: 100%" ShrinkLabel
                              Margin="Margin.Dense" Variant="Variant.Outlined" Label="Value" />
            </MudItem>
        }
    </MudGrid>
    <MudStack Spacing="2">
        <HUIButton Color="Color.Primary" Variant="Variant.Filled" FullWidth
                   OnClick="SaveChanges" Size="Size.Small"
                   Ripple="false" DropShadow="false">
            Lưu Thay Đổi
        </HUIButton>
        <HUIButton Color="Color.Secondary" Variant="Variant.Outlined" FullWidth
                   OnClick="@(() => NavigationManager.NavigateTo("/"))" Size="Size.Small"
                   Ripple="false" DropShadow="false">
            Trở Về
        </HUIButton>
    </MudStack>
</MudStack>

@code {
    private Dictionary<string, string> _keyValuePairs = [];

    protected override async Task OnInitializedAsync()
    {
        _keyValuePairs = DbContext.AppSettings.ToDictionary(p => p.Key, p => p.Value);
    }

    private void Reset()
    {
        _keyValuePairs = DbContext.AppSettings.ToDictionary(p => p.Key, p => p.Value);
    }

    private async Task SaveChanges()
    {
        try
        {
            foreach (var pair in _keyValuePairs)
            {
                var setting = await DbContext.AppSettings
                                .FirstOrDefaultAsync(x => x.Key == pair.Key);

                if (setting == null) continue;

                setting.Value = pair.Value;
            }

            await DbContext.SaveChangesAsync();

            NavigationManager.NavigateTo("/");

            Snackbar.Add("Đã lưu thay đổi", Severity.Success, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
        catch (Exception)
        {
            Snackbar.Add($"Có lỗi xảy ra! Thử lại sau!", Severity.Error, (cfg) =>
            {
                cfg.RequireInteraction = false;
                cfg.VisibleStateDuration = 800;
            });
        }
    }

    private async Task HandleValueChanged(string key, string value)
    {
        _keyValuePairs[key] = value;
        await InvokeAsync(StateHasChanged);
    }
}
